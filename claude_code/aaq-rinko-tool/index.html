<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AAQ-RINKO CSV 仕分け・結合ツール</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- encoding.js -->
  <script src="https://cdn.jsdelivr.net/npm/encoding-japanese@2/encoding.min.js"></script>
  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/custom.css">
</head>
<body class="bg-gray-100 min-h-screen" style="min-width:1280px;">

  <!-- ヘッダー -->
  <header class="bg-blue-800 text-white px-4 py-3 flex items-center justify-between shadow-md">
    <div class="flex items-center gap-3">
      <span class="text-xl font-bold">AAQ-RINKO CSV 仕分け・結合ツール</span>
      <span class="text-sm text-blue-200">v3.2</span>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn-output-a" class="btn-primary" disabled>
        形式A出力（生データ）
      </button>
      <button id="btn-output-b" class="btn-primary" disabled>
        形式B出力（水深区分別平均）
      </button>
      <button id="btn-reset-master" class="btn-danger hidden">
        マスタリセット
      </button>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="flex h-[calc(100vh-56px)]">

    <!-- 左ペイン: 地点マスタ -->
    <div class="w-1/3 flex flex-col border-r border-gray-300 bg-white overflow-hidden">

      <!-- 地点マスタドロップゾーン -->
      <div id="master-dropzone"
           class="dropzone m-3 rounded-lg border-2 border-dashed border-blue-400 bg-blue-50 p-4 text-center cursor-pointer flex-shrink-0"
           ondragover="event.preventDefault()" ondrop="app.onMasterDrop(event)">
        <div class="text-blue-600 font-medium mb-1">地点マスタCSVをドロップ</div>
        <div class="text-gray-500 text-sm">または</div>
        <label class="mt-1 inline-block cursor-pointer text-blue-600 underline text-sm">
          ファイルを選択
          <input type="file" id="master-file-input" accept=".csv" class="hidden" onchange="app.onMasterFileSelect(event)">
        </label>
        <div class="text-gray-400 text-xs mt-1">Shift_JIS / UTF-8 (BOM自動判定)</div>
      </div>

      <!-- 地点一覧 -->
      <div class="px-3 pb-1 flex items-center justify-between flex-shrink-0">
        <span class="text-sm font-semibold text-gray-700">地点一覧</span>
        <span id="master-count" class="text-xs text-gray-500"></span>
      </div>
      <div id="station-list" class="flex-1 overflow-y-auto px-3 pb-3">
        <div class="text-gray-400 text-sm text-center mt-8">地点マスタを読み込んでください</div>
      </div>
    </div>

    <!-- 右ペイン: 観測データ -->
    <div class="flex-1 flex flex-col overflow-hidden bg-gray-50">

      <!-- 観測データドロップゾーン -->
      <div id="obs-dropzone"
           class="dropzone m-3 rounded-lg border-2 border-dashed border-green-400 bg-green-50 p-3 text-center cursor-pointer flex-shrink-0"
           ondragover="event.preventDefault()" ondrop="app.onObsDrop(event)">
        <div class="text-green-700 font-medium">観測データCSVをドロップ（複数可）</div>
        <label class="inline-block cursor-pointer text-green-700 underline text-sm">
          ファイルを選択
          <input type="file" id="obs-file-input" accept=".csv" multiple class="hidden" onchange="app.onObsFileSelect(event)">
        </label>
        <div class="text-gray-400 text-xs">Shift_JIS / 複数ファイル対応</div>
      </div>

      <!-- スクロール可能エリア -->
      <div class="flex-1 overflow-y-auto px-3 pb-3" id="swimlane-container">

        <!-- 未分類エリア -->
        <div class="mb-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="font-semibold text-gray-700 text-sm">未分類</span>
            <span id="unclassified-count" class="badge badge-gray">0</span>
          </div>
          <div id="unclassified-area"
               class="swim-drop-target min-h-[60px] rounded-lg border-2 border-dashed border-gray-300 bg-white p-2 flex flex-wrap gap-2"
               data-station-id=""
               ondragover="uiController.onDragOver(event)"
               ondrop="uiController.onDrop(event)">
            <div class="unclassified-placeholder text-gray-400 text-sm w-full text-center py-2">ここにドラッグして未分類に移動</div>
          </div>
        </div>

        <!-- スイムレーン群（動的生成） -->
        <div id="swimlanes"></div>

      </div>
    </div>
  </main>

  <!-- ================== モーダル群 ================== -->

  <!-- 地図モーダル -->
  <div id="map-modal" class="modal-overlay hidden">
    <div class="modal-container" style="width:800px; height:580px;">
      <div class="modal-header">
        <span id="map-modal-title" class="font-semibold">地図</span>
        <button id="btn-add-point" class="btn-secondary btn-sm" style="margin-left:8px;"
          onclick="app.addStationFromMap()">＋ 地点を追加</button>
        <button class="modal-close" onclick="mapController.closeMapModal()">×</button>
      </div>
      <!-- overflow:hidden にして Leaflet タイルが切れないようにする -->
      <div style="flex:1; overflow:hidden; position:relative;">
        <div id="map" style="width:100%; height:100%; position:absolute; top:0; left:0; right:0; bottom:0;"></div>
      </div>
    </div>
  </div>

  <!-- プレビューモーダル -->
  <div id="preview-modal" class="modal-overlay hidden">
    <div class="modal-container" style="width:900px; max-height:80vh;">
      <div class="modal-header">
        <span id="preview-modal-title" class="font-semibold text-sm truncate"></span>
        <button class="modal-close" onclick="uiController.closePreviewModal()">×</button>
      </div>
      <div class="modal-body overflow-auto" style="max-height:calc(80vh - 44px);">
        <div id="preview-table-container"></div>
      </div>
    </div>
  </div>

  <!-- 地点追加・編集モーダル -->
  <div id="station-form-modal" class="modal-overlay hidden">
    <div class="modal-container" style="width:460px;">
      <div class="modal-header">
        <span id="station-form-title" class="font-semibold">地点を追加</span>
        <button class="modal-close" onclick="uiController.closeStationFormModal()">×</button>
      </div>
      <div class="modal-body p-4">
        <input type="hidden" id="sf-editing-id">
        <div class="form-group">
          <label class="form-label">地点名 <span class="text-red-500">*</span></label>
          <input type="text" id="sf-name" class="form-input" placeholder="例: 吾妻橋">
        </div>
        <div class="form-group">
          <label class="form-label">地点ID <span class="text-red-500">*</span></label>
          <input type="text" id="sf-id" class="form-input" placeholder="例: ST001">
        </div>
        <div class="form-group">
          <label class="form-label">調査区分 <span class="text-red-500">*</span></label>
          <select id="sf-category" class="form-input">
            <option value="定期">定期</option>
            <option value="臨時">臨時</option>
            <option value="未設定">未設定</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="form-group">
            <label class="form-label">緯度</label>
            <input type="number" id="sf-lat" class="form-input" placeholder="例: 34.318" step="any">
          </div>
          <div class="form-group">
            <label class="form-label">経度</label>
            <input type="number" id="sf-lon" class="form-input" placeholder="例: 132.449" step="any">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ファイル名キーワード</label>
          <input type="text" id="sf-keywords" class="form-input" placeholder="パイプ区切り (例: tukune|つくね)">
        </div>
        <div class="form-group">
          <label class="form-label">備考</label>
          <input type="text" id="sf-note" class="form-input" placeholder="メモ">
        </div>
        <div class="flex justify-end gap-2 mt-4">
          <button onclick="uiController.closeStationFormModal()" class="btn-secondary">キャンセル</button>
          <button onclick="app.saveStationForm()" class="btn-primary">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 確認ダイアログ（汎用） -->
  <div id="confirm-dialog" class="modal-overlay hidden">
    <div class="modal-container" style="width:420px;">
      <div class="modal-header">
        <span id="confirm-title" class="font-semibold"></span>
        <button class="modal-close" onclick="uiController.closeConfirm()">×</button>
      </div>
      <div class="modal-body p-4">
        <p id="confirm-message" class="text-gray-700 mb-4"></p>
        <div id="confirm-buttons" class="flex justify-end gap-2"></div>
      </div>
    </div>
  </div>

  <!-- トースト通知 -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

  <!-- JS モジュール -->
  <script src="js/fileHandler.js"></script>
  <script src="js/dataProcessor.js"></script>
  <script src="js/mapController.js"></script>
  <script src="js/uiController.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
