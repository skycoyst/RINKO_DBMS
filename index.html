<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAQ-RINKO CSV 仕分け・結合ツール</title>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet.js CSS (CDN) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- SortableJS for Drag and Drop (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        /* デスクトップアプリケーション風のレイアウト調整 */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #f3f4f6;
        }

        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header-bar {
            flex-shrink: 0;
        }

        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            gap: 1rem;
        }

        /* スイムレーンのスクロール領域 */
        .swimlane-scroller {
            display: flex;
            overflow-x: auto;
            gap: 0.5rem;
            padding: 0.5rem;
            min-height: 140px;
            align-items: stretch;
        }

        /* スイムレーンUI */
        .swimlane-row {
            display: flex;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            min-height: 160px;
        }

        .swimlane-header {
            width: 220px;
            flex-shrink: 0;
            padding: 1rem;
            border-right: 1px solid #e5e7eb;
            background-color: #f9fafb;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-top-left-radius: 0.5rem;
            border-bottom-left-radius: 0.5rem;
        }

        .swimlane-content {
            flex-grow: 1;
            position: relative;
            background-color: #f8fafc;
        }

        .swimlane-map-area {
            width: 250px;
            flex-shrink: 0;
            padding: 0.5rem;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            background-color: #f9fafb;
            border-top-right-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }

        /* 未分類エリア */
        .uncategorized-area {
            background-color: #fff1f2;
            border: 2px dashed #fda4af;
            border-radius: 0.5rem;
            min-height: 120px;
            padding: 0.5rem;
        }

        /* ファイルカード */
        .file-card {
            width: 200px;
            padding: 0.75rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            cursor: grab;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            user-select: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .file-card:active {
            cursor: grabbing;
            border-color: #3b82f6;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .file-card.highlight {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #3b82f6;
            background-color: #eff6ff;
        }

        /* ユーティリティ */
        .drag-hover {
            background-color: #e0f2fe !important;
            border-color: #bae6fd !important;
        }

        .map-container {
            width: 100%;
            height: 100%;
            min-height: 120px;
            border-radius: 0.25rem;
            z-index: 10;
        }

        /* スクロールバー装飾 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>

<body class="text-slate-800 font-sans">

    <div class="main-container">
        <!-- Header -->
        <header
            class="header-bar bg-white border-b border-slate-200 shadow-sm px-6 py-4 flex justify-between items-center z-20">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
                <h1 class="text-xl font-bold tracking-tight text-slate-800">AAQ-RINKO CSV 仕分け・結合ツール</h1>
            </div>

            <div class="flex items-center gap-4">
                <button id="btnLoadMaster"
                    class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-md text-sm font-medium transition-colors border border-slate-300 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    地点マスタ読込
                </button>
                <button id="btnMapAdd"
                    class="px-4 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-md text-sm font-medium transition-colors border border-green-200 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    地点追加
                </button>
                <div class="h-6 w-px bg-slate-300"></div>
                <button id="btnExportCSV"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors flex items-center gap-2 shadow-sm pointer-events-none opacity-50">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    結合データ出力
                </button>
                <button id="btnDownloadMaster"
                    class="px-4 py-2 text-slate-600 hover:text-slate-900 text-sm font-medium underline">
                    地点マスタDL
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="content-area" id="dropZoneMain">
            <!-- Full page drop zone overlay -->
            <div id="dropOverlay"
                class="fixed inset-0 bg-slate-900/50 z-50 hidden flex-row p-6 gap-6 backdrop-blur-sm pointer-events-none">
                <!-- Overlay Left 1/3: Master -->
                <div id="overlayZoneMaster"
                    class="w-1/3 h-full flex flex-col justify-center items-center border-4 border-emerald-400 border-dashed rounded-2xl bg-emerald-50/95 shadow-2xl transition-transform duration-200">
                    <svg class="w-20 h-20 text-emerald-500 mb-4 animate-[bounce_2s_infinite]" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <h2 class="text-3xl font-bold text-emerald-700 tracking-tight">地点マスタ</h2>
                    <p class="text-emerald-600 mt-2 font-medium">ここにドロップしてマスタを更新</p>
                </div>
                <!-- Overlay Right 2/3: Data -->
                <div id="overlayZoneData"
                    class="w-2/3 h-full flex flex-col justify-center items-center border-4 border-blue-400 border-dashed rounded-2xl bg-blue-50/95 shadow-2xl transition-transform duration-200">
                    <svg class="w-20 h-20 text-blue-500 mb-4 animate-bounce" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                        </path>
                    </svg>
                    <h2 class="text-4xl font-bold text-blue-700 tracking-tight">観測データ追加</h2>
                    <p class="text-blue-600 mt-3 font-medium text-lg">観測データ (.csv) をここに追加</p>
                </div>
            </div>

            <!-- Dashboard Stats & Instructions -->
            <div id="welcomeMessage" class="flex h-[calc(100vh-100px)] w-full gap-6 p-6">
                <!-- Master Drop Area -->
                <div id="dropZoneMasterStatic"
                    class="relative w-1/3 border-4 border-dashed border-emerald-300 rounded-2xl bg-emerald-50 flex flex-col items-center justify-center text-emerald-700 transition-all hover:bg-emerald-100">
                    <svg class="w-16 h-16 mb-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <h2 class="text-lg md:text-2xl font-bold mb-2 text-center">地点マスタ<br>ドロップゾーン</h2>
                    <p class="text-sm text-emerald-600 mb-6 text-center font-medium">地点マスタのCSVを左側に<br>ドラッグ＆ドロップしてください
                    </p>

                    <button id="btnDownloadTemplate"
                        class="px-5 py-2.5 bg-white hover:bg-emerald-50 text-emerald-700 rounded-md text-sm font-bold transition-colors border border-emerald-300 flex items-center gap-2 shadow-sm z-10">
                        <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        テンプレートをDL
                    </button>
                    <!-- Visual cue that it's droppable -->
                    <div class="absolute inset-x-0 bottom-4 text-center text-xs text-emerald-500 opacity-70">Drop Here
                    </div>
                </div>

                <!-- Data Drop Area (Placeholder during Master missing) -->
                <div id="dropZoneDataStatic"
                    class="relative w-2/3 border-4 border-dashed border-slate-300 rounded-2xl bg-slate-50 flex flex-col items-center justify-center text-slate-500 transition-all">
                    <svg class="w-16 h-16 mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2">
                        </path>
                    </svg>
                    <h2 class="text-2xl font-bold text-slate-400 mb-2">観測データ<br>ドロップゾーン</h2>
                    <p class="text-slate-400 text-center font-medium">先に左側のエリアに地点マスタを読み込ませてください</p>
                </div>
            </div>

            <!-- Swimlanes Container -->
            <div id="swimlanesContainer" class="flex flex-col gap-4 hidden">
                <!-- Swimlanes will be injected here -->
            </div>

            <!-- Uncategorized Area -->
            <div id="uncategorizedContainer" class="mt-8 hidden">
                <h3 class="text-sm font-bold text-rose-700 uppercase tracking-wider mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                        </path>
                    </svg>
                    未分類・判定不可
                </h3>
                <div class="uncategorized-area flex flex-wrap gap-2" id="uncategorizedLane">
                    <!-- Uncategorized files will be injected here -->
                    <div
                        class="w-full text-center text-rose-300 text-sm py-8 italic border-2 border-dashed border-rose-200 rounded-md">
                        判定できなかったファイルがここに表示されます。手動で各地点にドラッグしてください。
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="masterFileInput" accept=".csv" class="hidden">
    <input type="file" id="dataFileInput" accept=".csv" multiple class="hidden">

    <!-- Modal: Data Preview -->
    <div id="previewModal"
        class="fixed inset-0 bg-slate-900 bg-opacity-50 z-50 hidden flex justify-center items-center">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-5xl h-5/6 flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2" id="previewTitle">
                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        filename.csv
                    </h3>
                    <p class="text-xs text-slate-500 mt-1" id="previewSubtitle">0件 | 最大 0.0m | 位置情報なし</p>
                </div>
                <button id="btnClosePreview" class="text-slate-400 hover:text-slate-600 p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="flex-grow overflow-auto p-0 m-0 relative bg-white">
                <table class="min-w-full text-left text-sm whitespace-nowrap hidden" id="previewTable">
                    <thead class="bg-slate-100 sticky top-0 border-b border-slate-300 shadow-sm z-10">
                        <tr id="previewTableHeader">
                            <!-- Headers injected here -->
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200" id="previewTableBody">
                        <!-- Data injected here -->
                    </tbody>
                </table>
                <div id="previewLoading"
                    class="absolute inset-0 flex justify-center items-center bg-white bg-opacity-75">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
            </div>
            <div class="px-6 py-3 border-t border-slate-200 bg-slate-50 text-right">
                <button id="btnModalClose"
                    class="px-4 py-2 bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 rounded-md text-sm font-medium">閉じる</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Map Location -->
    <div id="addLocationModal"
        class="fixed inset-0 bg-slate-900 bg-opacity-50 z-50 hidden flex justify-center items-center">
        <div class="bg-white rounded-lg shadow-xl w-3/4 max-w-4xl h-3/4 flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800">新規地点追加</h3>
                <button id="btnCloseLocationModal" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="flex-grow flex">
                <!-- Map Area -->
                <div class="w-2/3 h-full border-r border-slate-200 bg-slate-100 relative">
                    <div id="pickerMap" class="w-full h-full"></div>
                    <div
                        class="absolute bottom-4 left-4 right-4 bg-white bg-opacity-90 p-3 rounded-md shadow text-sm border border-slate-200 z-[1000]">
                        <span class="font-bold text-blue-700">操作方法:</span> 地図上をクリックして座標を選択してください。<br>
                        <span class="text-xs text-slate-500">※オフライン時は地図が表示されません。右側のフォームに直接値を入力してください。</span>
                    </div>
                </div>
                <!-- Form Area -->
                <div class="w-1/3 p-6 flex flex-col gap-4 overflow-y-auto">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">地点名 <span
                                class="text-rose-500">*</span></label>
                        <input type="text" id="addLocName"
                            class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="例: ツクネ">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">調査区分</label>
                        <input type="text" id="addLocType"
                            class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="例: 河川">
                    </div>
                    <div class="flex gap-2">
                        <div class="w-1/2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">緯度</label>
                            <input type="text" id="addLocLat"
                                class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="w-1/2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">経度</label>
                            <input type="text" id="addLocLng"
                                class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">備考</label>
                        <input type="text" id="addLocNote"
                            class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">ファイル名キーワード</label>
                        <input type="text" id="addLocKeywords"
                            class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="例: tukune|tsukune （パイプ区切り）">
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-3">
                <button id="btnCancelAddLoc"
                    class="px-4 py-2 bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 rounded-md text-sm font-medium">キャンセル</button>
                <button id="btnConfirmAddLoc"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium">地点を追加</button>
            </div>
        </div>
    </div>


    <!-- Leaflet.js (CDN) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Application Logic -->
    <script src="app.js"></script>
</body>

</html>